


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > CreateNewVaultPasswordController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.cryptomator.ui.addvaultwizard</a>
</div>

<h1>Coverage Summary for Class: CreateNewVaultPasswordController (org.cryptomator.ui.addvaultwizard)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CreateNewVaultPasswordController</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/94)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.cryptomator.ui.addvaultwizard;
&nbsp;
&nbsp;import dagger.Lazy;
&nbsp;import org.cryptomator.common.vaults.Vault;
&nbsp;import org.cryptomator.common.vaults.VaultListManager;
&nbsp;import org.cryptomator.cryptofs.CryptoFileSystemProperties;
&nbsp;import org.cryptomator.cryptofs.CryptoFileSystemProvider;
&nbsp;import org.cryptomator.cryptolib.api.CryptoException;
&nbsp;import org.cryptomator.cryptolib.api.CryptorProvider;
&nbsp;import org.cryptomator.cryptolib.api.Masterkey;
&nbsp;import org.cryptomator.cryptolib.api.MasterkeyLoader;
&nbsp;import org.cryptomator.cryptolib.common.MasterkeyFileAccess;
&nbsp;import org.cryptomator.ui.changepassword.NewPasswordController;
&nbsp;import org.cryptomator.ui.common.FxController;
&nbsp;import org.cryptomator.ui.common.FxmlFile;
&nbsp;import org.cryptomator.ui.common.FxmlScene;
&nbsp;import org.cryptomator.ui.common.Tasks;
&nbsp;import org.cryptomator.ui.fxapp.FxApplicationWindows;
&nbsp;import org.cryptomator.ui.recoverykey.RecoveryKeyFactory;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;
&nbsp;import javax.inject.Inject;
&nbsp;import javax.inject.Named;
&nbsp;import javafx.beans.binding.Bindings;
&nbsp;import javafx.beans.binding.ObjectBinding;
&nbsp;import javafx.beans.property.BooleanProperty;
&nbsp;import javafx.beans.property.IntegerProperty;
&nbsp;import javafx.beans.property.ObjectProperty;
&nbsp;import javafx.beans.property.SimpleBooleanProperty;
&nbsp;import javafx.beans.property.StringProperty;
&nbsp;import javafx.fxml.FXML;
&nbsp;import javafx.scene.Scene;
&nbsp;import javafx.scene.control.ContentDisplay;
&nbsp;import javafx.scene.control.Toggle;
&nbsp;import javafx.scene.control.ToggleGroup;
&nbsp;import javafx.stage.Stage;
&nbsp;import java.io.IOException;
&nbsp;import java.io.UncheckedIOException;
&nbsp;import java.nio.channels.WritableByteChannel;
&nbsp;import java.nio.file.FileSystem;
&nbsp;import java.nio.file.Files;
&nbsp;import java.nio.file.Path;
&nbsp;import java.nio.file.StandardOpenOption;
&nbsp;import java.security.SecureRandom;
&nbsp;import java.util.ResourceBundle;
&nbsp;import java.util.concurrent.ExecutorService;
&nbsp;
&nbsp;import static java.nio.charset.StandardCharsets.US_ASCII;
&nbsp;import static org.cryptomator.common.Constants.DEFAULT_KEY_ID;
&nbsp;import static org.cryptomator.common.Constants.MASTERKEY_FILENAME;
&nbsp;
&nbsp;@AddVaultWizardScoped
&nbsp;public class CreateNewVaultPasswordController implements FxController {
&nbsp;
<b class="nc">&nbsp;	private static final Logger LOG = LoggerFactory.getLogger(CreateNewVaultPasswordController.class);</b>
&nbsp;
&nbsp;	private final Stage window;
&nbsp;	private final Lazy&lt;Scene&gt; chooseExpertSettingsScene;
&nbsp;	private final Lazy&lt;Scene&gt; recoveryKeyScene;
&nbsp;	private final Lazy&lt;Scene&gt; successScene;
&nbsp;	private final FxApplicationWindows appWindows;
&nbsp;	private final ExecutorService executor;
&nbsp;	private final RecoveryKeyFactory recoveryKeyFactory;
&nbsp;	private final StringProperty vaultNameProperty;
&nbsp;	private final ObjectProperty&lt;Path&gt; vaultPathProperty;
&nbsp;	private final ObjectProperty&lt;Vault&gt; vaultProperty;
&nbsp;	private final StringProperty recoveryKeyProperty;
&nbsp;	private final VaultListManager vaultListManager;
&nbsp;	private final ResourceBundle resourceBundle;
&nbsp;	private final ReadmeGenerator readmeGenerator;
&nbsp;	private final SecureRandom csprng;
&nbsp;	private final MasterkeyFileAccess masterkeyFileAccess;
&nbsp;	private final BooleanProperty processing;
&nbsp;	private final BooleanProperty readyToCreateVault;
&nbsp;	private final ObjectBinding&lt;ContentDisplay&gt; createVaultButtonState;
&nbsp;	private final IntegerProperty shorteningThreshold;
&nbsp;
&nbsp;	/* FXML */
&nbsp;	public ToggleGroup recoveryKeyChoice;
&nbsp;	public Toggle showRecoveryKey;
&nbsp;	public Toggle skipRecoveryKey;
&nbsp;	public NewPasswordController newPasswordSceneController;
&nbsp;
&nbsp;	@Inject
&nbsp;	CreateNewVaultPasswordController(@AddVaultWizardWindow Stage window, //
&nbsp;									 @FxmlScene(FxmlFile.ADDVAULT_NEW_EXPERT_SETTINGS) Lazy&lt;Scene&gt; chooseExpertSettingsScene, //
&nbsp;									 @FxmlScene(FxmlFile.ADDVAULT_NEW_RECOVERYKEY) Lazy&lt;Scene&gt; recoveryKeyScene, //
&nbsp;									 @FxmlScene(FxmlFile.ADDVAULT_SUCCESS) Lazy&lt;Scene&gt; successScene, //
&nbsp;									 FxApplicationWindows appWindows, //
&nbsp;									 ExecutorService executor, //
&nbsp;									 RecoveryKeyFactory recoveryKeyFactory, //
&nbsp;									 @Named(&quot;vaultName&quot;) StringProperty vaultName, //
&nbsp;									 ObjectProperty&lt;Path&gt; vaultPath, //
&nbsp;									 @AddVaultWizardWindow ObjectProperty&lt;Vault&gt; vault, //
&nbsp;									 @Named(&quot;recoveryKey&quot;) StringProperty recoveryKey, //
&nbsp;									 VaultListManager vaultListManager, //
&nbsp;									 ResourceBundle resourceBundle, //
&nbsp;									 @Named(&quot;shorteningThreshold&quot;) IntegerProperty shorteningThreshold, //
&nbsp;									 ReadmeGenerator readmeGenerator, //
&nbsp;									 SecureRandom csprng, //
<b class="nc">&nbsp;									 MasterkeyFileAccess masterkeyFileAccess) {</b>
<b class="nc">&nbsp;		this.window = window;</b>
<b class="nc">&nbsp;		this.chooseExpertSettingsScene = chooseExpertSettingsScene;</b>
<b class="nc">&nbsp;		this.recoveryKeyScene = recoveryKeyScene;</b>
<b class="nc">&nbsp;		this.successScene = successScene;</b>
<b class="nc">&nbsp;		this.appWindows = appWindows;</b>
<b class="nc">&nbsp;		this.executor = executor;</b>
<b class="nc">&nbsp;		this.recoveryKeyFactory = recoveryKeyFactory;</b>
<b class="nc">&nbsp;		this.vaultNameProperty = vaultName;</b>
<b class="nc">&nbsp;		this.vaultPathProperty = vaultPath;</b>
<b class="nc">&nbsp;		this.vaultProperty = vault;</b>
<b class="nc">&nbsp;		this.recoveryKeyProperty = recoveryKey;</b>
<b class="nc">&nbsp;		this.vaultListManager = vaultListManager;</b>
<b class="nc">&nbsp;		this.resourceBundle = resourceBundle;</b>
<b class="nc">&nbsp;		this.readmeGenerator = readmeGenerator;</b>
<b class="nc">&nbsp;		this.csprng = csprng;</b>
<b class="nc">&nbsp;		this.masterkeyFileAccess = masterkeyFileAccess;</b>
<b class="nc">&nbsp;		this.processing = new SimpleBooleanProperty();</b>
<b class="nc">&nbsp;		this.readyToCreateVault = new SimpleBooleanProperty();</b>
<b class="nc">&nbsp;		this.createVaultButtonState = Bindings.when(processing).then(ContentDisplay.LEFT).otherwise(ContentDisplay.TEXT_ONLY);</b>
<b class="nc">&nbsp;		this.shorteningThreshold = shorteningThreshold;</b>
&nbsp;	}
&nbsp;
&nbsp;	@FXML
&nbsp;	public void initialize() {
<b class="nc">&nbsp;		readyToCreateVault.bind(newPasswordSceneController.goodPasswordProperty().and(recoveryKeyChoice.selectedToggleProperty().isNotNull()).and(processing.not()));</b>
<b class="nc">&nbsp;		window.setOnHiding(event -&gt; {</b>
<b class="nc">&nbsp;			newPasswordSceneController.passwordField.wipe();</b>
<b class="nc">&nbsp;			newPasswordSceneController.reenterField.wipe();</b>
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;	@FXML
&nbsp;	public void back() {
<b class="nc">&nbsp;		window.setScene(chooseExpertSettingsScene.get());</b>
&nbsp;	}
&nbsp;
&nbsp;	@FXML
&nbsp;	public void next() {
<b class="nc">&nbsp;		if (showRecoveryKey.equals(recoveryKeyChoice.getSelectedToggle())) {</b>
<b class="nc">&nbsp;			showRecoveryKeyScene();</b>
<b class="nc">&nbsp;		} else if (skipRecoveryKey.equals(recoveryKeyChoice.getSelectedToggle())) {</b>
<b class="nc">&nbsp;			showSuccessScene();</b>
&nbsp;		} else {
<b class="nc">&nbsp;			throw new IllegalStateException(&quot;Unexpected toggle state&quot;);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void showRecoveryKeyScene() {
<b class="nc">&nbsp;		Path pathToVault = vaultPathProperty.get();</b>
<b class="nc">&nbsp;		processing.set(true);</b>
<b class="nc">&nbsp;		Tasks.create(() -&gt; {</b>
<b class="nc">&nbsp;			createVault(pathToVault);</b>
<b class="nc">&nbsp;			return recoveryKeyFactory.createRecoveryKey(pathToVault, newPasswordSceneController.passwordField.getCharacters());</b>
<b class="nc">&nbsp;		}).onSuccess(recoveryKey -&gt; {</b>
<b class="nc">&nbsp;			creationSucceeded(pathToVault);</b>
<b class="nc">&nbsp;			recoveryKeyProperty.set(recoveryKey);</b>
<b class="nc">&nbsp;			window.setScene(recoveryKeyScene.get());</b>
<b class="nc">&nbsp;		}).onError(IOException.class, e -&gt; {</b>
<b class="nc">&nbsp;			LOG.error(&quot;Failed to create vault.&quot;, e);</b>
<b class="nc">&nbsp;			appWindows.showErrorWindow(e, window, window.getScene());</b>
<b class="nc">&nbsp;		}).andFinally(() -&gt; {</b>
<b class="nc">&nbsp;			processing.set(false);</b>
<b class="nc">&nbsp;		}).runOnce(executor);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void showSuccessScene() {
<b class="nc">&nbsp;		Path pathToVault = vaultPathProperty.get();</b>
<b class="nc">&nbsp;		processing.set(true);</b>
<b class="nc">&nbsp;		Tasks.create(() -&gt; {</b>
<b class="nc">&nbsp;			createVault(pathToVault);</b>
<b class="nc">&nbsp;		}).onSuccess(() -&gt; {</b>
<b class="nc">&nbsp;			creationSucceeded(pathToVault);</b>
<b class="nc">&nbsp;			window.setScene(successScene.get());</b>
<b class="nc">&nbsp;		}).onError(IOException.class, e -&gt; {</b>
<b class="nc">&nbsp;			LOG.error(&quot;Failed to create vault.&quot;, e);</b>
<b class="nc">&nbsp;			appWindows.showErrorWindow(e, window, window.getScene());</b>
<b class="nc">&nbsp;		}).andFinally(() -&gt; {</b>
<b class="nc">&nbsp;			processing.set(false);</b>
<b class="nc">&nbsp;		}).runOnce(executor);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void createVault(Path path) throws IOException {
&nbsp;		// 0. create directory
<b class="nc">&nbsp;		Files.createDirectory(path);</b>
&nbsp;
&nbsp;		// 1. write masterkey:
<b class="nc">&nbsp;		Path masterkeyFilePath = path.resolve(MASTERKEY_FILENAME);</b>
<b class="nc">&nbsp;		try (Masterkey masterkey = Masterkey.generate(csprng)) {</b>
<b class="nc">&nbsp;			masterkeyFileAccess.persist(masterkey, masterkeyFilePath, newPasswordSceneController.passwordField.getCharacters());</b>
&nbsp;
&nbsp;			// 2. initialize vault:
&nbsp;			try {
<b class="nc">&nbsp;				MasterkeyLoader loader = ignored -&gt; masterkey.copy();</b>
<b class="nc">&nbsp;				CryptoFileSystemProperties fsProps = CryptoFileSystemProperties.cryptoFileSystemProperties() //</b>
<b class="nc">&nbsp;						.withCipherCombo(CryptorProvider.Scheme.SIV_GCM) //</b>
<b class="nc">&nbsp;						.withKeyLoader(loader) //</b>
<b class="nc">&nbsp;						.withShorteningThreshold(shorteningThreshold.get()) //</b>
<b class="nc">&nbsp;						.build();</b>
<b class="nc">&nbsp;				CryptoFileSystemProvider.initialize(path, fsProps, DEFAULT_KEY_ID);</b>
&nbsp;
&nbsp;				// 3. write vault-internal readme file:
<b class="nc">&nbsp;				String vaultReadmeFileName = resourceBundle.getString(&quot;addvault.new.readme.accessLocation.fileName&quot;);</b>
<b class="nc">&nbsp;				try (FileSystem fs = CryptoFileSystemProvider.newFileSystem(path, fsProps); //</b>
<b class="nc">&nbsp;					 WritableByteChannel ch = Files.newByteChannel(fs.getPath(&quot;/&quot;, vaultReadmeFileName), StandardOpenOption.CREATE_NEW, StandardOpenOption.WRITE)) {</b>
<b class="nc">&nbsp;					ch.write(US_ASCII.encode(readmeGenerator.createVaultAccessLocationReadmeRtf()));</b>
<b class="nc">&nbsp;				}</b>
<b class="nc">&nbsp;			} catch (CryptoException e) {</b>
<b class="nc">&nbsp;				throw new IOException(&quot;Vault initialization failed&quot;, e);</b>
&nbsp;			}
<b class="nc">&nbsp;		}</b>
&nbsp;
&nbsp;		// 4. write vault-external readme file:
<b class="nc">&nbsp;		String storagePathReadmeFileName = resourceBundle.getString(&quot;addvault.new.readme.storageLocation.fileName&quot;);</b>
<b class="nc">&nbsp;		try (WritableByteChannel ch = Files.newByteChannel(path.resolve(storagePathReadmeFileName), StandardOpenOption.CREATE_NEW, StandardOpenOption.WRITE)) {</b>
<b class="nc">&nbsp;			ch.write(US_ASCII.encode(readmeGenerator.createVaultStorageLocationReadmeRtf()));</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
<b class="nc">&nbsp;		LOG.info(&quot;Created vault at {}&quot;, path);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void creationSucceeded(Path pathToVault) {
&nbsp;		try {
<b class="nc">&nbsp;			Vault newVault = vaultListManager.add(pathToVault);</b>
<b class="nc">&nbsp;			vaultProperty.set(newVault);</b>
<b class="nc">&nbsp;		} catch (IOException e) {</b>
<b class="nc">&nbsp;			throw new UncheckedIOException(e);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	/* Getter/Setter */
&nbsp;
&nbsp;	public String getVaultName() {
<b class="nc">&nbsp;		return vaultNameProperty.get();</b>
&nbsp;	}
&nbsp;
&nbsp;	public StringProperty vaultNameProperty() {
<b class="nc">&nbsp;		return vaultNameProperty;</b>
&nbsp;	}
&nbsp;
&nbsp;	public BooleanProperty readyToCreateVaultProperty() {
<b class="nc">&nbsp;		return readyToCreateVault;</b>
&nbsp;	}
&nbsp;
&nbsp;	public boolean isReadyToCreateVault() {
<b class="nc">&nbsp;		return readyToCreateVault.get();</b>
&nbsp;	}
&nbsp;
&nbsp;	public ObjectBinding&lt;ContentDisplay&gt; createVaultButtonStateProperty() {
<b class="nc">&nbsp;		return createVaultButtonState;</b>
&nbsp;	}
&nbsp;
&nbsp;	public ContentDisplay getCreateVaultButtonState() {
<b class="nc">&nbsp;		return createVaultButtonState.get();</b>
&nbsp;	}
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-10-10 15:12</div>
</div>
</body>
</html>
